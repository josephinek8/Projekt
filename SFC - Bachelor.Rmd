---
title: "SFC"
author: "Josephine Kærsgaard"
date: "2023-04-12"
output: word_document
---
```{r}
library(sfcr)
library(tidyverse)
library(tidygraph)


#Step 1: Write the balance sheet matrix

bs_pension <- sfcr_matrix(
  columns = c("Arbejdsstyrken", "Pensionister", "Production", "Government"),
  code = c("a","pen", "p", "g"),
  c("Money", a = "+M_a", pen="+M_ua", g = "-Ms"),
  c("Loans", g = "-Lg", a ="+L"), 
  c("Wealth", a = "-V_a", pen="-V_ua", g = "+V")
)

sfcr_matrix_display(bs_pension)
# We check the consistency of the model using the balance sheet
```


```{r}
#Step 2_ Write the TFM

tfm_pension <- sfcr_matrix(
  columns = c("Arbejdsstyrken", "Pensionister", "Production", "Government"),
  codes = c("a", "pen", "p", "g"),
  c("Consumption", a = "-C_a", pen="-C_pen", p = "+C"),
  c("Government Expenditure", p = "+G", g = "-G"),
  c("Income = GDP", a = "+Y", p = "-Y"),
  c("Interest on Loans/Public Debt", g = "-r[-1]*L_g[-1]", a = "r[-1]*L[-1]"), 
  c("Pension payouts", pen = "+FP", g = "-FP"),
  c("Contributions to social security", a = "-Ss", g = "+Ss"),
  c("Tax on Income", a = "-T_a", g = "+T_a"), 
  c("Tax on Pension", pen = "-T_pen", g = "+T_pen"),
  c("Change in Money", a = "-(M_a - M_a[-1])", pen = "-(M_pen- M_pen[-1])", g = "(Ms - Ms[-1])"),
  c("Change in Loans/Public Debt", g = "(Lg - Lg[-1])", a = "-(L - L[-1])")
)

sfcr_matrix_display(tfm_pension)
```


```{r}
# Write the system of equations

pension_eqs <- sfcr_set(
  #Hvordan defineres aktive og passive husholdninger som andele af hele befolkningen???
  
  #Definition af befolkning, arbejdsløse m.m
  Lf ~ beta * Pop, #arbejdsstyrken
  N ~ Y/pr, # efterspørgslen efter arbejdskraft. 
  Ul~ Lf - N, #andelen af arbejdsløse af den samlede arbejdsstyrke
  Pen ~ Pop - Lf, #andelen af pensionister
  
  #Regnskabsidentiteter
  Y ~ C + G,
  
  #Adfærdsliginger
  Yd_a ~ Y - T_a,
  Yd_pen ~ FP - T_pen, #Forskellige skatterater? eller skal en skattesats ganges på?
  Yd ~ Yd_ah + Yd_ph,
 
  FP ~ tau * G, #Folkepension som en del af de offentlige udgifter.
  Ss ~ gamma * Yd_a,
 
  #Skatter
  T_a ~ theta * Y, 
  T_pen ~ omega * FP,
  T ~ T_a + T_pen,
  
  #Forbrug
  C_a ~ alpha1_a * Yd_a + alpha2_a * V_a[-1],
  C_pen ~ alpha1_pen * Yd_pen + alpha2_pen * V_pen[-1],
  C ~ C_a + C_pen,
  
  
  #Formue
  V_a ~ V_a[-1] + Yd_a - C_a,
  V_pen ~ V_pen[-1] + Yd_pen - C_pen,
  V ~ V_a + V_pen, 
  M_a ~ V_a,
  M_pen ~ V_pen, 
  M ~ M_a + M_pen,
  
  #Ændringer i stocks
  Ms ~ Ms[-1] + (Ms - Ms[-1]), #skal sidste parentes med?
  Lg ~ Lg[-1]+(G+r[-1]*Lg[-1]+FP)- T
)
```


```{r}
#sfcr_sankey(tfm_pension, pension)
# Set values for the exogenous variables and the parameters

pension_ext <- sfcr_set(
  # Exogenous
  
  r ~ 0.025,
  G ~ 20,
  theta ~ 0.4, 
  omega ~ 0.25,
  tau ~ 0.1,
  beta ~ 0.7,
  gamma ~ 0.2,
  pr ~ 1, 
  
  # Parameters
  
  alpha1_ah ~ 0.6,
  alpha2_ah ~ 0.4,
  alpha1_ph ~ 0.4,
  alpha2_ph ~ 0.6
)

#Set initial values

pension_initial <- sfcr_set(
  M ~ 21.62,
  Ms ~ 21.62,
  V ~ 86.485,
  Pop ~ 100 # Samlede befolkning
)
```


```{r}
# Simulate the baseline model

pension <- sfcr_baseline(
  equations = pension_eqs,
  external = pension_ext,
  initial = pension_initial,
  periods = 100,
  hidden = c("Hh" = "Hs")
)
```


```{r}
# We check the consistency of the model using the balance sheet

sfcr_validate(
  matrix = bs_pc,
  baseline = pc,
  which = "bs")

# We check the consistency of the model using the TFM

sfcr_validate(
  matrix = tfm_pc,
  baseline = pc,
  which = "tfm"
)
```


```{r}
#Create a table showing some of the variables of the model

pc %>%
  filter(period %in% c(1, 2, 30, 50, 80, 100)) %>%
  select(period, G, Y, Yd, C) %>%
  t() %>%
  round(digits = 1)

# We create  a DAG

sfcr_dag_cycles_plot(pc_eqs)

# We create  a Sankey (Leave this one out due to errors)

sfcr_sankey(tfm_pc, pc)

#### SCENARIO

# Create a scenario where the interest rate increases from 0.025 to 0.035

shock <- sfcr_shock(
  variables = sfcr_set(
    r ~ 0.035  
  ),
  start = 15,
  end = 100
)

# Create the scenario where the shock takes place

pc1 <- sfcr_scenario(
  baseline = pc,
  scenario = shock,
  periods = 100
)


# We create the variables defining the shares of money and bills in Households portfolio.
# We use pc1 to see the impact of the change in the interest in the portfolio allocation.
pc1 %>%
  filter(period %in% c(3, 15, 16, 17, 18, 100)) %>%
  select(period, G, Y, Yd, C) %>%
  t() %>%
  round(digits = 1)

pc1$BV <- pc1$Bh/pc1$V
pc1$MV <- pc1$Hh/pc1$V

pc1_long <- pc1 %>%
  pivot_longer(cols = -period)

#Figure 4.3 (if you change lambda1 ~ 5 to a lower number you get 
# the fluctuations from the book, but lower share of BV)

pc1_long %>%
  filter(name %in% c("BV", "MV")) %>%
  ggplot(aes(x = period, y = value)) +
  geom_line() +
  facet_wrap(~ name, scales = 'free_y') +
  labs(title = "Wealth alocation")

#Figure 4.4 (Remark, that it seems like Yd and C are identical
# This is not the case if you look at the table)

pc1_long %>%
  filter(name %in% c("Yd", "C")) %>%
  ggplot(aes(x = period, y = value)) +
  geom_line(aes(linetype = name)) +
  labs(title = "Evolution of disposable income and household consumption")

```

